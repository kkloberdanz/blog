<h2 class="posttitle">Implementing Math Operations From Scratch</h2>
<h5>04 July 2021</h5>
<img class="img" src="image/exp.svg" />
<p>
    In programming, we use a lot of mathematical functions and operations
    without thinking much about how they work, or how they're implemented. In
    this post, I'm going to walk through and explain how one <b><i>could</i></b>
    implement a few common math functions. The implementations here are not
    taken from any particular library. Standard library implementations of math
    functions are commonly highly optimized and can sometimes be hard to read.
    The purpose of this blog post is to make the code very readable and
    understandable, with some performance optimizations sprinkled on top so long
    as it doesn't hinder readability.
</p>

<p>
    Let's start by looking at one of the most useful numbers in existance,
    <i>e</i>. Euler's number, or <i>e</i> is a mathematical constant that is
    better generalized by the exponential function, namely the exponential
    function evaluated at 1
</p>
<div class="codeblock">
    exp(1) = e
</div>

<p>
    More generally,
</p>
<div class="codeblock">
    exp(x) = e^x
</div>

<p>
    The exponential function is convienently defined by a Taylor Series, which
    we can see below.
</p>
<img class="img" src="image/exp_x.svg" />

<p>
    In Computer Science, we have the awful connundrum of trying to simulate real
    mathematics (i.e., operations on real numbers) with finite precision. We
    attempt to approximate fields with infinite precision with finite precision
    constructs such as floating point numbers, which fail to meet even the basic
    group axioms (e.g., associativity). Such a conundrum means that for most
    scientific computing work, we must make do with approximations of real
    numbers.
</p>

<p>
    Fortunately, in this case, <i>exp(x)</i> is a convergent series, and
    therefore we can approximate the true result with a finite number of terms
    from the Taylor Series.
</p>

<p>
    Let's use this Taylor Series to implemnt the exponential function in C.
</p>

<div class="codeblock">
    <pre>
    <font color="#AF5F00">  1 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;stdio.h&gt;</font>
    <font color="#AF5F00">  2 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;stdbool.h&gt;</font>
    <font color="#AF5F00">  3 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;math.h&gt;</font>
    <font color="#AF5F00">  4 </font>
    <font color="#AF5F00">  5 </font><font color="#4E9A06">bool</font> is_prime(<font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> n) {
    <font color="#AF5F00">  6 </font>    <font color="#AF5F00">if</font> (n &lt; <font color="#CC0000">2</font>) {
    <font color="#AF5F00">  7 </font>        <font color="#AF5F00">return</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00">  8 </font>    } <font color="#AF5F00">else</font> {
    <font color="#AF5F00">  9 </font>        <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> max = sqrt(n) + <font color="#CC0000">1</font>;
    <font color="#AF5F00"> 10 </font>        <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> i;
    <font color="#AF5F00"> 11 </font>        <font color="#AF5F00">for</font> (i = <font color="#CC0000">2</font>; i &lt; max; i++) {
    <font color="#AF5F00"> 12 </font>            <font color="#AF5F00">if</font> (n % i == <font color="#CC0000">0</font>) {
    <font color="#AF5F00"> 13 </font>                <font color="#AF5F00">return</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00"> 14 </font>            }
    <font color="#AF5F00"> 15 </font>        }
    <font color="#AF5F00"> 16 </font>        <font color="#AF5F00">return</font> <font color="#CC0000">true</font>;
    <font color="#AF5F00"> 17 </font>    }
    <font color="#AF5F00"> 18 </font>}
    <font color="#AF5F00"> 19 </font>
    <font color="#AF5F00"> 20 </font><font color="#4E9A06">int</font> main(<font color="#4E9A06">void</font>) {
    <font color="#AF5F00"> 21 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> start = <font color="#CC0000">9223372036854775808UL</font>;
    <font color="#AF5F00"> 22 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> end = start + <font color="#CC0000">1000</font>;
    <font color="#AF5F00"> 23 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> i;
    <font color="#AF5F00"> 24 </font>
    <font color="#AF5F00"> 25 </font>    <font color="#AF5F00">for</font> (i = start; i &lt; end; i++) {
    <font color="#AF5F00"> 26 </font>        printf(<font color="#CC0000">&quot;testing: </font><font color="#75507B">%lu\n</font><font color="#CC0000">&quot;</font>, i);
    <font color="#AF5F00"> 27 </font>        <font color="#AF5F00">if</font> (is_prime(i)) {
    <font color="#AF5F00"> 28 </font>            printf(<font color="#CC0000">&quot;</font><font color="#75507B">%lu</font><font color="#CC0000"> is prime</font><font color="#75507B">\n</font><font color="#CC0000">&quot;</font>, i);
    <font color="#AF5F00"> 29 </font>        }
    <font color="#AF5F00"> 30 </font>    }
    <font color="#AF5F00"> 31 </font>    <font color="#AF5F00">return</font> <font color="#CC0000">0</font>;
    <font color="#AF5F00"> 32 </font>}
    </pre>
</div>

<div class="codeblock">
    <pre>
    $ clang -o single single.c -fopenmp -Wall -Wextra -Wpedantic -O2 -lm
    $ time ./single
    9223372036854775837 is prime
    9223372036854775907 is prime
    9223372036854775931 is prime
    9223372036854775939 is prime
    9223372036854775963 is prime
    9223372036854776063 is prime
    9223372036854776077 is prime
    9223372036854776167 is prime
    9223372036854776243 is prime
    9223372036854776257 is prime
    9223372036854776261 is prime
    9223372036854776293 is prime
    9223372036854776299 is prime
    9223372036854776351 is prime
    9223372036854776393 is prime
    9223372036854776407 is prime
    9223372036854776561 is prime
    9223372036854776657 is prime
    9223372036854776687 is prime
    9223372036854776693 is prime
    9223372036854776711 is prime
    9223372036854776803 is prime
    
    real    10m28.951s
    user    10m28.739s
    sys     0m0.020s
    </pre>
</div>

<h4>
    10m28.951s - Now that we have a baseline, let's start multithreading with
    OpenMP!
</h4>

<p>
    As you can see, I only had to add a few lines to make this program
    multithreaded. I simply added the <strong>pragma</strong> to tell openmp to
    parallelize this for loop, as well as a <strong>critical</strong>
    section to enforce that only a single thread can print at a time. This will
    keep our messages from colliding with each other.
</p>

<div class="codeblock">
    <pre>
    <font color="#AF5F00">  1 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;stdio.h&gt;</font>
    <font color="#AF5F00">  2 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;stdbool.h&gt;</font>
    <font color="#AF5F00">  3 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;math.h&gt;</font>
    <font color="#AF5F00">  4 </font>
    <font color="#AF5F00">  5 </font><font color="#4E9A06">bool</font> is_prime(<font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> n) {
    <font color="#AF5F00">  6 </font>    <font color="#AF5F00">if</font> (n &lt; <font color="#CC0000">2</font>) {
    <font color="#AF5F00">  7 </font>        <font color="#AF5F00">return</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00">  8 </font>    } <font color="#AF5F00">else</font> {
    <font color="#AF5F00">  9 </font>        <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> max = sqrt(n) + <font color="#CC0000">1</font>;
    <font color="#AF5F00"> 10 </font>        <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> i;
    <font color="#AF5F00"> 11 </font>        <font color="#AF5F00">for</font> (i = <font color="#CC0000">2</font>; i &lt; max; i++) {
    <font color="#AF5F00"> 12 </font>            <font color="#AF5F00">if</font> (n % i == <font color="#CC0000">0</font>) {
    <font color="#AF5F00"> 13 </font>                <font color="#AF5F00">return</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00"> 14 </font>            }
    <font color="#AF5F00"> 15 </font>        }
    <font color="#AF5F00"> 16 </font>        <font color="#AF5F00">return</font> <font color="#CC0000">true</font>;
    <font color="#AF5F00"> 17 </font>    }
    <font color="#AF5F00"> 18 </font>}
    <font color="#AF5F00"> 19 </font>
    <font color="#AF5F00"> 20 </font><font color="#4E9A06">int</font> main(<font color="#4E9A06">void</font>) {
    <font color="#AF5F00"> 21 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> start = <font color="#CC0000">9223372036854775808UL</font>;
    <font color="#AF5F00"> 22 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> end = start + <font color="#CC0000">1000</font>;
    <font color="#AF5F00"> 23 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> i;
    <font color="#AF5F00"> 24 </font>
    <font color="#AF5F00"> 25 </font>    <font color="#75507B">#pragma omp parallel </font><font color="#AF5F00">for</font><font color="#75507B"> schedule(</font><font color="#4E9A06">static</font><font color="#75507B">)</font>
    <font color="#AF5F00"> 26 </font>    <font color="#AF5F00">for</font> (i = start; i &lt; end; i++) {
    <font color="#AF5F00"> 27 </font>        <font color="#AF5F00">if</font> (is_prime(i)) {
    <font color="#AF5F00"> 28 </font>            <font color="#75507B">#pragma omp critical</font>
    <font color="#AF5F00"> 29 </font>            {
    <font color="#AF5F00"> 30 </font>                printf(<font color="#CC0000">&quot;</font><font color="#75507B">%lu</font><font color="#CC0000"> is prime</font><font color="#75507B">\n</font><font color="#CC0000">&quot;</font>, i);
    <font color="#AF5F00"> 31 </font>            }
    <font color="#AF5F00"> 32 </font>        }
    <font color="#AF5F00"> 33 </font>    }
    <font color="#AF5F00"> 34 </font>    <font color="#AF5F00">return</font> <font color="#CC0000">0</font>;
    <font color="#AF5F00"> 35 </font>}
    </pre>
</div>

<div class="codeblock">
    <pre>
    $ clang -o static static.c -fopenmp -Wall -Wextra -Wpedantic -O2 -lm
    9223372036854776351 is prime
    9223372036854775837 is prime
    9223372036854775939 is prime
    9223372036854776063 is prime
    9223372036854776167 is prime
    9223372036854776657 is prime
    9223372036854776561 is prime
    9223372036854776393 is prime
    9223372036854776687 is prime
    9223372036854776257 is prime
    9223372036854776803 is prime
    9223372036854775907 is prime
    9223372036854776243 is prime
    9223372036854775963 is prime
    9223372036854776077 is prime
    9223372036854776407 is prime
    9223372036854776693 is prime
    9223372036854776261 is prime
    9223372036854775931 is prime
    9223372036854776711 is prime
    9223372036854776293 is prime
    9223372036854776299 is prime
    
    real    2m14.245s
    user    15m17.936s
    sys     0m0.212s
    </pre>
</div>

<p>
    2m14.245s - That's a quite a bit bit faster... but let's think about how the
    complexity of our prime algorithm works. If we start with the number
    <strong>96</strong>, then when we apply our
    <strong>is_prime</strong> function, the first thing we divide by is
    <strong>2</strong>... which has a remainder of <strong>0</strong>, and then
    we're done.<br />
</p>
<p>
    Next number, <strong>97</strong><br />
    Let's try <strong>2</strong>. Is the remainder <strong>0</strong>? no<br />
    How about <strong>3</strong>? no<br />
    Maybe <strong>4</strong>? no<br />
    <strong>5</strong>? no<br />
    <strong>6</strong>? no<br />
    <strong>7</strong>? no<br />
    <strong>8</strong>? no<br />
    <strong>9</strong>? no<br />
    <strong>10</strong>? no<br />
    And now we have tested numbers up to the <strong>sqrt(97)</strong>, and we
    can now conclude that <strong>97</strong> is prime!
</p>

<p>
    <strong>97</strong> was <strong>A LOT</strong> more work to test than
    <strong>96</strong> even though they were right next to each other!
</p>

<p>
    This algorithm has wildly different runtimes for different inputs, so let's
    get smarter with how we multithread it. Let's try to keep those worker
    threads as busy as possible!
</p>

<h4>
    In OpenMP, changing the scheduling type is as simple as replacing static
    with dynamic
</h4>

<div class="codeblock">
    <pre>
    <font color="#AF5F00">  1 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;stdio.h&gt;</font>
    <font color="#AF5F00">  2 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;stdbool.h&gt;</font>
    <font color="#AF5F00">  3 </font><font color="#75507B">#include </font><font color="#CC0000">&lt;math.h&gt;</font>
    <font color="#AF5F00">  4 </font>
    <font color="#AF5F00">  5 </font><font color="#4E9A06">bool</font> is_prime(<font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> n) {
    <font color="#AF5F00">  6 </font>    <font color="#AF5F00">if</font> (n &lt; <font color="#CC0000">2</font>) {
    <font color="#AF5F00">  7 </font>        <font color="#AF5F00">return</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00">  8 </font>    } <font color="#AF5F00">else</font> {
    <font color="#AF5F00">  9 </font>        <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> max = sqrt(n) + <font color="#CC0000">1</font>;
    <font color="#AF5F00"> 10 </font>        <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> i;
    <font color="#AF5F00"> 11 </font>        <font color="#AF5F00">for</font> (i = <font color="#CC0000">2</font>; i &lt; max; i++) {
    <font color="#AF5F00"> 12 </font>            <font color="#AF5F00">if</font> (n % i == <font color="#CC0000">0</font>) {
    <font color="#AF5F00"> 13 </font>                <font color="#AF5F00">return</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00"> 14 </font>            }
    <font color="#AF5F00"> 15 </font>        }
    <font color="#AF5F00"> 16 </font>        <font color="#AF5F00">return</font> <font color="#CC0000">true</font>;
    <font color="#AF5F00"> 17 </font>    }
    <font color="#AF5F00"> 18 </font>}
    <font color="#AF5F00"> 19 </font>
    <font color="#AF5F00"> 20 </font><font color="#4E9A06">int</font> main(<font color="#4E9A06">void</font>) {
    <font color="#AF5F00"> 21 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> start = <font color="#CC0000">9223372036854775808UL</font>;
    <font color="#AF5F00"> 22 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> end = start + <font color="#CC0000">1000</font>;
    <font color="#AF5F00"> 23 </font>    <font color="#4E9A06">unsigned</font> <font color="#4E9A06">long</font> i;
    <font color="#AF5F00"> 24 </font>
    <font color="#AF5F00"> 25 </font>    <font color="#75507B">#pragma omp parallel </font><font color="#AF5F00">for</font><font color="#75507B"> schedule(dynamic)</font>
    <font color="#AF5F00"> 26 </font>    <font color="#AF5F00">for</font> (i = start; i &lt; end; i++) {
    <font color="#AF5F00"> 27 </font>        <font color="#AF5F00">if</font> (is_prime(i)) {
    <font color="#AF5F00"> 28 </font>            <font color="#75507B">#pragma omp critical</font>
    <font color="#AF5F00"> 29 </font>            {
    <font color="#AF5F00"> 30 </font>                printf(<font color="#CC0000">&quot;</font><font color="#75507B">%lu</font><font color="#CC0000"> is prime</font><font color="#75507B">\n</font><font color="#CC0000">&quot;</font>, i);
    <font color="#AF5F00"> 31 </font>            }
    <font color="#AF5F00"> 32 </font>        }
    <font color="#AF5F00"> 33 </font>    }
    <font color="#AF5F00"> 34 </font>    <font color="#AF5F00">return</font> <font color="#CC0000">0</font>;
    <font color="#AF5F00"> 35 </font>}
    </pre>
</div>

<div class="codeblock">
    <pre>
    clang -o dynamic dynamic.c -fopenmp -Wall -Wextra -Wpedantic -O2 -lm
    time ./dynamic
    9223372036854775939 is prime
    9223372036854775931 is prime
    9223372036854776167 is prime
    9223372036854776063 is prime
    9223372036854776257 is prime
    9223372036854776077 is prime
    9223372036854775963 is prime
    9223372036854775907 is prime
    9223372036854776243 is prime
    9223372036854775837 is prime
    9223372036854776261 is prime
    9223372036854776293 is prime
    9223372036854776299 is prime
    9223372036854776407 is prime
    9223372036854776393 is prime
    9223372036854776711 is prime
    9223372036854776351 is prime
    9223372036854776687 is prime
    9223372036854776693 is prime
    9223372036854776657 is prime
    9223372036854776803 is prime
    9223372036854776561 is prime
    
    real    1m24.828s
    user    18m10.744s
    sys     0m0.436s
    </pre>
</div>

<p>
    1m24.828s - That's a pretty good speedup, considering all we had to do was
    understand what kind of work our algorithm was doing, and tweak how we use
    OMP with a single line change!
</p>

<p class="foot-notes">
    * All benchmarks were run on a an AMD Ryzen 7 2700X Eight-Core Processor,
    running Ubuntu 18.04
</p>
